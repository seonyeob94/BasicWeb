<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chart.js í†µí•© í…ŒìŠ¤íŠ¸</title>

  <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="../js/chart.umd.min.js"></script>
  <script src="../js/jquery-3.7.1.js"></script>

  <script>
  let myChart;
  let myChart1;

  $(function() {
      // ì²« ë²ˆì§¸ ì°¨íŠ¸ (ë§‰ëŒ€ê·¸ë˜í”„)
      const ctx = document.getElementById('myChart').getContext('2d');
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            {
              label: 'ì›”ë³„ ëŒ€ì¶œ ê±´ìˆ˜',
              data: [],
              backgroundColor: 'rgba(54, 162, 235, 0.6)'
            },
            {
              label: 'ë°˜ë‚© ê±´ìˆ˜',
              data: [],
              backgroundColor: 'rgba(75, 192, 192, 0.6)'
            },
            {
              label: 'ì—°ì²´ ê±´ìˆ˜',
              data: [],
              backgroundColor: 'rgba(255, 99, 132, 0.6)'
            }
          ]
        },
        options: {
          responsive: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      // ë‘ ë²ˆì§¸ ì°¨íŠ¸ (íŒŒì´ ì°¨íŠ¸)
      const ctx1 = document.getElementById('myChart1').getContext('2d');
      myChart1 = new Chart(ctx1, {
        type: 'pie',
        data: {
          labels: ["ì •ìƒë°˜ë‚©", "ì—°ì²´", "ë¯¸ë°˜ë‚©"],
          datasets: [{
            data: [],
            backgroundColor: [
              'rgba(54, 162, 235, 0.6)',
              'rgba(75, 192, 192, 0.6)',
              'rgba(255, 99, 132, 0.6)'
            ]
          }]
        },
        options: {
          responsive: false
        }
      });

      // ë¹„ë™ê¸° fetch ë²„íŠ¼
      $("#fetch_member").on('click', function() {
          fetch("/practic_project/Chart1.do") // controller ì—°ê²°
          .then(resp => {
              if (resp.ok) {
                  return resp.json();
              } else {
                  throw new Error(resp.statusText);
              }
          })
          .then(data => {
              console.log(data);

              // ì›”ë³„ ë°ì´í„° ì²˜ë¦¬
              const monthly = data.monthlyStats;
              const labels = monthly.map(item => item.MONTHNO);
              const counts = monthly.map(item => item.TOTALLOANS);
              const returns = monthly.map(item => item.TOTALRETURNS);
              const overdues = monthly.map(item => item.OVERDUERETURNS);

              myChart.data.labels = labels;
              myChart.data.datasets[0].data = counts;
              myChart.data.datasets[1].data = returns;
              myChart.data.datasets[2].data = overdues;
              myChart.update();

              // ì „ì²´ ë°ì´í„° ì²˜ë¦¬
              const stats = data.overallStats[0]; // ê²°ê³¼ëŠ” í•œ ì¤„(row)ë§Œ
              const values = [
                  stats.ONTIMERETURNS,
                  stats.OVERDUERETURNS,
                  stats.NOTRETURNED
              ];

              myChart1.data.datasets[0].data = values;
              myChart1.update();
          })
          .catch(err => {
              console.log(err);
          });
      });
  });
  </script>

  <style>
    #myChart, #myChart1 {
      width: 400px;
      height: 200px;
    }
    body {
      font-family: 'Arial', sans-serif;
    }
  </style>
</head>

<body>
  <h2>ğŸ“Š ëŒ€ì¶œ/ë°˜ë‚©/ì—°ì²´ ì›”ë³„ í†µê³„</h2>
  <canvas id="myChart"></canvas><br><br>
  <h2>ğŸ“ˆ ë°˜ë‚© ìƒíƒœ(ì •ìƒ/ì—°ì²´/ë¯¸ë°˜ë‚©) ë¹„ìœ¨</h2>
  <canvas id="myChart1"></canvas><br><br>
  <input type="button" value="ë¹„ë™ê¸° fetch" id="fetch_member">
</body>
</html>
