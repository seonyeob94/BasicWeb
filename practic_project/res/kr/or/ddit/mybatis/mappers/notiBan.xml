<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="notiBan">

		

	<resultMap id="notiMap" type="Noti">
	    <result property="notiNo" column="notiNo"/>
	    <result property="notiType" column="notiType"/>
	    <result property="message" column="message"/>
	    <result property="sentDate" column="sentDate"/>
	    <result property="userNo" column="userNo"/>
	</resultMap>

	<select id="selectBanUserMap" resultType="map">
	    SELECT u.USER_NO     as "userNo"
	         , u.NAME   as "name"
	         , b.BOOK_TITLE  as "bookTitle"
	         , u.EMAIL       as "email"
	         , u.PHONE    as "phone"
	         , TRUNC(SYSDATE)-TRUNC(bl.DUE_DATE)   as "banDays"
	         , u.STATUS      as "status"
	    FROM USERS u
	    JOIN BOOK_LOANS bl ON u.USER_NO = bl.USER_NO
	    JOIN BAN_USERS bu ON u.USER_NO = bu.USER_NO
	    JOIN REAL_BOOK r ON bl.REAL_BOOK=r.REAL_BOOK
	    JOIN BOOKS b ON R.BOOK_NO=b.BOOK_NO
	   WHERE bl.RETURN_DATE IS NULL
	     AND SYSDATE &gt; bl.DUE_DATE
	  </select>

	    <select id="selectLoanContact" parameterType="int" resultType="map">
		    SELECT u.USER_NO    AS userNo
		         , u.NAME       AS userName
		         , u.EMAIL      AS email
		         , bl.LOAN_NO   AS loanNo
		         , bl.DUE_DATE  AS dueDate
		    FROM USERS u
		    JOIN BOOK_LOANS bl ON u.USER_NO = bl.USER_NO
		    WHERE bl.LOAN_NO = #{loanNo}
		  </select>
		
		  <!-- 3) 경고 이력 남기기 -->
		  <insert id="insertWarningHistory" parameterType="int">
		    INSERT INTO NOTIFICATION_HISTORY
		      (HIST_ID, LOAN_NO, TYPE, SENT_AT)
		    VALUES
		      (NOTIF_HIST_SEQ.NEXTVAL, #{loanNo}, 'OVERDUE_WARNING', SYSDATE)
		  </insert>
	
	
	
	
	
</mapper>
